<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <link rel="icon" href="icon.png" type="image/png">
  <link rel="apple-touch-icon" href="icon.png">
  <title>ã ã‚ŒãŒæ­Œã£ã¦ã‚‹ï¼Ÿ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="styles.css">
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body class="scroll-page">

  <div class="box">
    <p id="quiz-counter" style="text-align: center; font-size: 14px; color: #888; margin-bottom: 5px;"></p>
      <div class="progress-container">
      <div id="progress-bar" class="progress-bar"></div>
      </div>
    <h2 class="title">ã ã‚ŒãŒæ­Œã£ã¦ã‚‹ï¼Ÿ</h2>
    <div id="prev-lyrics" class="hint-lyrics" style="display:none;"></div>
    <p id="lyrics">èª­ã¿è¾¼ã¿ä¸­â€¦</p>
    <div id="next-lyrics" class="hint-lyrics" style="display:none;"></div>
    <div class="members" id="members"></div>
    <button class="submit" id="submitBtn">å›ç­”ã™ã‚‹</button>
    <p id="result"></p>
    <div id="explanation"></div>
    <button class="submit" id="nextBtn" style="display:none;">æ¬¡ã®å•é¡Œã¸</button>
  </div>

  <script>
    // 1. ã¾ãšSupabaseã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’å³åº§ã«ä½œæˆã™ã‚‹
    const SUPABASE_URL = "https://atinpqtedmrfrtdlkpkd.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF0aW5wcXRlZG1yZnJ0ZGxrcGtkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkwOTU0NjcsImV4cCI6MjA4NDY3MTQ2N30.Oor6oUuuIxa0pSxIRuwEw7ZzGYM4hOGfywHqv2FaBHg";
    
    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY, {
      auth: {
        persistSession: false,
        storageKey: 'sb-temp',
        storage: {
          getItem: () => null,
          setItem: () => {},
          removeItem: () => {}
        }
      }
    });

    // 2. ãã®ä»–ã®å¤‰æ•°è¨­å®š
    const quizState = JSON.parse(localStorage.getItem("quizState"));
    if (!quizState) location.href = "index.html";

    let quizzes = [];
    let currentIndex = 0;
    let currentQuiz = null;
    let members = [];
    let selectedMembers = new Set();

    // 3. ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿é–¢æ•°
    async function loadQuizzesAndMembers() {
      // é›£æ˜“åº¦æŒ‡å®šã®ã‚«ãƒ©ãƒ ãŒ1ã§ã‚ã‚‹ã‚‚ã®ã‚’å–å¾—
      const { data: quizData, error: quizError } = await supabaseClient
        .from("quizzes")
        .select("*")
        .eq("group_name", quizState.group)
        .eq(quizState.difficulty, 1);

      if (quizError || !quizData || quizData.length === 0) {
        document.getElementById("lyrics").textContent = "å•é¡Œã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ";
        return;
      }

      // ç¢ºç‡èª¿æ•´ãƒ•ã‚£ãƒ«ã‚¿
      const filteredQuizzes = quizData.filter(quiz => {
        const rate = (quiz.Question_rate !== null && quiz.Question_rate !== undefined) ? quiz.Question_rate : 1.0; 
        return Math.random() < rate;
      });

      // ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã—ã¦10å•
      quizzes = filteredQuizzes.sort(() => Math.random() - 0.5).slice(0, 10);
      console.log("ã€ãƒ‡ãƒãƒƒã‚°ã€‘é¸å‡ºã•ã‚ŒãŸã‚¯ã‚¤ã‚ºIDä¸€è¦§:", quizzes.map(q => q.id));

      if (quizzes.length === 0) {
        document.getElementById("lyrics").textContent = "æ¡ä»¶ã«åˆã†å•é¡ŒãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ";
        return;
      }

      // ãƒ¡ãƒ³ãƒãƒ¼å–å¾—
      const { data: memberData, error: memberError } = await supabaseClient
        .from("members")
        .select("*")
        .eq("group_name", quizState.group)
        .order("sort_order");

      if (!memberError && memberData) {
        members = memberData;
        showQuiz(0);
      }
    }

    function showQuiz(index) {
      currentIndex = index;
      currentQuiz = quizzes[index];
      // --- ã“ã“ã‚’è¿½åŠ ï¼šã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã®è¡¨ç¤ºæ›´æ–° ---
      // indexã¯0ã‹ã‚‰å§‹ã¾ã‚‹ã®ã§ +1 ã—ã¦è¡¨ç¤ºã—ã¾ã™
      document.getElementById("quiz-counter").textContent = `${index + 1} / ${quizzes.length} å•ç›®`;
      // â˜…é€²æ—ãƒãƒ¼ã®æ›´æ–°
      const progressPercent = ((index + 1) / quizzes.length) * 100;
      document.getElementById("progress-bar").style.width = progressPercent + "%";
      
      document.getElementById("lyrics").textContent = currentQuiz.lyrics_main;

      const prevEl = document.getElementById("prev-lyrics");
      const nextEl = document.getElementById("next-lyrics");

      if (quizState.difficulty === "easy") {
        const prevText = [currentQuiz.lyrics_prev1, currentQuiz.lyrics_prev2].filter(t => t).join("<br>");
        const nextText = [currentQuiz.lyrics_next1, currentQuiz.lyrics_next2].filter(t => t).join("<br>");
        updateHint(prevEl, "-ç›´å‰ã®æ­Œè©-", prevText);
        updateHint(nextEl, "-ç›´å¾Œã®æ­Œè©-", nextText);
      } else if (quizState.difficulty === "normal") {
        updateHint(prevEl, "-ç›´å‰ã®æ­Œè©-", currentQuiz.lyrics_prev2);
        updateHint(nextEl, "-ç›´å¾Œã®æ­Œè©-", currentQuiz.lyrics_next1);
      } else {
        prevEl.style.display = "none";
        nextEl.style.display = "none";
      }

      selectedMembers.clear();
      renderMembers();
      const resultEl = document.getElementById("result");
      resultEl.textContent = "";
      resultEl.className = ""; // ã“ã‚Œã§ "correct" ã‚„ "incorrect" ã‚¯ãƒ©ã‚¹ã‚’ã™ã¹ã¦æ¶ˆå»ã—ã¾ã™
      
      const explanationEl = document.getElementById("explanation");
      explanationEl.textContent = "";

      const submitBtn = document.getElementById("submitBtn");
      submitBtn.style.display = "block"; // å¾©æ´»ã•ã›ã‚‹
      submitBtn.disabled = false;
      
      document.getElementById("nextBtn").style.display = "none";
    }

    function updateHint(el, label, text) {
      if (text && text.trim() !== "") {
        el.innerHTML = `<span class="hint-label">${label}</span><br>${text}`;
        el.style.display = "block";
      } else {
        el.style.display = "none";
      }
    }

    function renderMembers() {
      const container = document.getElementById("members");
      container.innerHTML = "";
      
      members.forEach(m => {
        const btn = document.createElement("button");
        btn.textContent = m.name;
        btn.className = "member-btn";
        btn.onclick = () => {
          if (selectedMembers.has(m.name)) {
            selectedMembers.delete(m.name);
            btn.classList.remove("on");
          } else {
            selectedMembers.add(m.name);
            btn.classList.add("on");
          }
        };
        container.appendChild(btn);
      });

      const allBtn = document.createElement("button");
      allBtn.textContent = "å…¨å“¡";
      // classã« "all-btn" ã‚’è¿½åŠ ã—ã¦CSSã¨ç´ä»˜ã‘ã¾ã™
      allBtn.className = "member-btn all-btn";

      allBtn.onclick = () => {
        // :not(.all-btn) ã«ã™ã‚‹ã“ã¨ã§ã€Œå…¨å“¡ã€ãƒœã‚¿ãƒ³è‡ªèº«ã‚’é™¤å¤–ã—ã¦åˆ¤å®š
        const memberButtons = document.querySelectorAll(".member-btn:not(:last-child)");
        const allOn = [...memberButtons].every(b => b.classList.contains("on"));

        memberButtons.forEach(b => {
          if (allOn) { 
            b.classList.remove("on"); 
            selectedMembers.delete(b.textContent); 
          } else { 
            b.classList.add("on"); 
            selectedMembers.add(b.textContent); 
          }
        });
        allBtn.classList.toggle("on", !allOn);
      };
      container.appendChild(allBtn);
    }

    document.getElementById("submitBtn").onclick = () => {
      if (selectedMembers.size === 0) return;
      const correct = currentQuiz.correct_members.split(",").map(s => s.trim()).sort();
      const answer = Array.from(selectedMembers).sort();
      const isCorrect = correct.length === answer.length && correct.every((v, i) => v === answer[i]);

      const res = document.getElementById("result");
      res.textContent = isCorrect ? `â­• æ­£è§£ï¼ğŸ˜„ï¼ˆæ­£è§£ï¼š${correct.join("ãƒ»")}ï¼‰` : `âŒ ä¸æ­£è§£ï¼ğŸ˜«ï¼ˆæ­£è§£ï¼š${correct.join("ãƒ»")}ï¼‰`;
      res.className = isCorrect ? "correct animate" : "incorrect animate";

      document.getElementById("explanation").textContent = (currentQuiz.song_title && currentQuiz.explanation) ? `ã“ã®æ­Œè©ã¯ã€Œ${currentQuiz.song_title}ã€ã®${currentQuiz.explanation}éƒ¨åˆ†ã§ã—ãŸï¼` : "";
      
      if (isCorrect) quizState.correctCount++;
            localStorage.setItem("quizState", JSON.stringify(quizState));

            // ä¿®æ­£ï¼šå›ç­”ãƒœã‚¿ãƒ³ã‚’ã€Œç„¡åŠ¹åŒ–ã€ã§ã¯ãªãã€Œéè¡¨ç¤ºã€ã«ã™ã‚‹
            document.getElementById("submitBtn").style.display = "none";
            // æ¬¡ã®å•é¡Œã¸ã‚’è¡¨ç¤º
            document.getElementById("nextBtn").style.display = "block"; 
            
            setTimeout(() => window.scrollTo({ top: document.body.scrollHeight, behavior: "smooth" }), 100);
    };

    document.getElementById("nextBtn").onclick = () => {
      if (currentIndex + 1 < quizzes.length) {
        showQuiz(currentIndex + 1);
        window.scrollTo({ top: 0, behavior: "smooth" });
      } else {
        location.href = "result.html";
      }
    };

    // æœ€å¾Œã«å®Ÿè¡Œ
    loadQuizzesAndMembers();
  </script>
</body>
</html>