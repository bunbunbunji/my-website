<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ã ã‚ŒãŒæ­Œã£ã¦ã‚‹ï¼Ÿ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link rel="stylesheet" href="styles.css">
</head>
<body class="scroll-page">

  <div class="box">
    <h2 class="title">ã ã‚ŒãŒæ­Œã£ã¦ã‚‹ï¼Ÿ</h2>
    <div id="prev-lyrics" class="hint-lyrics" style="display:none;"></div>
    <p id="lyrics">èª­ã¿è¾¼ã¿ä¸­â€¦</p>
    <div id="next-lyrics" class="hint-lyrics" style="display:none;"></div>
    <div class="members" id="members"></div>
    <button class="submit" id="submitBtn">å›ç­”ã™ã‚‹</button>
    <button class="submit" id="nextBtn" style="display:none;">æ¬¡ã®å•é¡Œã¸</button>
    <p id="result"></p>
    <div id="explanation"></div>

  </div>

  <script>
  const SUPABASE_URL = "https://atinpqtedmrfrtdlkpkd.supabase.co";
  const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF0aW5wcXRlZG1yZnJ0ZGxrcGtkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkwOTU0NjcsImV4cCI6MjA4NDY3MTQ2N30.Oor6oUuuIxa0pSxIRuwEw7ZzGYM4hOGfywHqv2FaBHg";
  const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  const quizState = JSON.parse(localStorage.getItem("quizState"));
  if (!quizState) location.href = "index.html";

  let quizzes = [];
  let currentIndex = 0;
  let currentQuiz = null;
  let members = [];
  let selectedMembers = new Set();

  // åˆæœŸãƒ­ãƒ¼ãƒ‰
  loadQuizzesAndMembers();

  async function loadQuizzesAndMembers() {
    const { data: quizData, error: quizError } = await supabaseClient
      .from("quizzes")
      .select("*")
      .eq("group_name", quizState.group)
      .eq("difficulty", quizState.difficulty);

    if (quizError || !quizData || quizData.length === 0) {
      document.getElementById("lyrics").textContent = "å•é¡Œã‚’å–å¾—ã§ãã¾ã›ã‚“";
      return;
    }

    quizzes = quizData
      .sort(() => Math.random() - 0.5)
      .slice(0, 10);

    const { data: memberData, error: memberError } = await supabaseClient
      .from("members")
      .select("*")
      .eq("group_name", quizState.group)
      .order("sort_order");

    if (memberError || !memberData || memberData.length === 0) {
      document.getElementById("lyrics").textContent = "ãƒ¡ãƒ³ãƒãƒ¼æƒ…å ±ã‚’å–å¾—ã§ãã¾ã›ã‚“";
      return;
    }

    members = memberData;

    currentIndex = 0;
    showQuiz(currentIndex);
  }

  function showQuiz(index) {
  currentQuiz = quizzes[index];
  document.getElementById("lyrics").textContent = currentQuiz.lyrics_main;

  const prevEl = document.getElementById("prev-lyrics");
  const nextEl = document.getElementById("next-lyrics");

  // â˜… é›£æ˜“åº¦ã«å¿œã˜ãŸãƒ’ãƒ³ãƒˆè¡¨ç¤ºã®åˆ†å²
  if (quizState.difficulty === "easy") {
    // ã€ã‚„ã•ã—ã„ã€‘å‰å¾Œ2è¡Œãšã¤è¡¨ç¤º
    const prevText = [currentQuiz.lyrics_prev1, currentQuiz.lyrics_prev2].filter(t => t).join("<br>");
    const nextText = [currentQuiz.lyrics_next1, currentQuiz.lyrics_next2].filter(t => t).join("<br>");
    
    updateHint(prevEl, "-ç›´å‰ã®æ­Œè©-", prevText);
    updateHint(nextEl, "-ç›´å¾Œã®æ­Œè©-", nextText);

  } else if (quizState.difficulty === "normal") {
    // ã€ãµã¤ã†ã€‘ç›´å‰1è¡Œ(prev2)ã¨ç›´å¾Œ1è¡Œ(next1)ã®ã¿è¡¨ç¤º
    updateHint(prevEl, "-ç›´å‰ã®æ­Œè©-", currentQuiz.lyrics_prev2);
    updateHint(nextEl, "-ç›´å¾Œã®æ­Œè©-", currentQuiz.lyrics_next1);

  } else {
    // ã€ã‚€ãšã‹ã—ã„ã€‘ãƒ’ãƒ³ãƒˆãªã—
    prevEl.style.display = "none";
    nextEl.style.display = "none";
  }

  // --- è£œåŠ©é–¢æ•° (ã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ãƒƒã‚­ãƒªã•ã›ã‚‹ãŸã‚) ---
  function updateHint(el, label, text) {
    if (text && text.trim() !== "") {
      el.innerHTML = `<span class="hint-label">${label}</span><br>${text}`;
      el.style.display = "block";
    } else {
      el.style.display = "none";
    }
  }
    selectedMembers.clear();
    renderMembers();

    const resultEl = document.getElementById("result");
    resultEl.textContent = "";
    resultEl.classList.remove("correct", "incorrect", "animate");

    const explanationEl = document.getElementById("explanation");
    explanationEl.textContent = "";

    const submitBtn = document.getElementById("submitBtn");
    submitBtn.disabled = false;
    submitBtn.classList.remove("flash-red");

    document.getElementById("nextBtn").style.display = "none";
  }

  function renderMembers() {
    const container = document.getElementById("members");
    container.innerHTML = "";
    members.forEach(m => {
      const btn = document.createElement("button");
      btn.textContent = m.name;
      btn.className = "member-btn";
      btn.onclick = () => toggleMember(btn, m.name);
      container.appendChild(btn);
    });

    const allBtn = document.createElement("button");
    allBtn.textContent = "å…¨å“¡";
    allBtn.className = "member-btn";
    allBtn.onclick = () => toggleAll(allBtn);
    container.appendChild(allBtn);
  }

  function toggleMember(btn, name) {
    if (selectedMembers.has(name)) {
      selectedMembers.delete(name);
      btn.classList.remove("on");
    } else {
      selectedMembers.add(name);
      btn.classList.add("on");
    }
  }

  function toggleAll(allBtn) {
    const memberButtons = document.querySelectorAll(".member-btn:not(:last-child)");
    const allOn = [...memberButtons].every(b => b.classList.contains("on"));
    memberButtons.forEach(btn => {
      const name = btn.textContent;
      if (allOn) {
        btn.classList.remove("on");
        selectedMembers.delete(name);
      } else {
        btn.classList.add("on");
        selectedMembers.add(name);
      }
    });
    allBtn.classList.toggle("on", !allOn);
  }

  // å›ç­”ãƒœã‚¿ãƒ³
  document.getElementById("submitBtn").onclick = () => {
    const resultEl = document.getElementById("result");
    const explanationEl = document.getElementById("explanation");
    const submitBtn = document.getElementById("submitBtn");

    if (!currentQuiz) return;

    if (selectedMembers.size === 0) {
      resultEl.textContent = "èª°ã‚‚é¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ï¼";
      submitBtn.classList.add("flash-red");
      submitBtn.addEventListener(
        "animationend",
        () => submitBtn.classList.remove("flash-red"),
        { once: true }
      );
      return;
    }

    const correct = currentQuiz.correct_members.split(",").map(s => s.trim()).sort();
    const answer = Array.from(selectedMembers).sort();
    const isCorrect =
      correct.length === answer.length &&
      correct.every((v, i) => v === answer[i]);

    /* â˜… explanation è¿½åŠ ã“ã“ã‹ã‚‰ */
    const explanationText =
      currentQuiz.song_title && currentQuiz.explanation
      ? `ã“ã®æ­Œè©ã¯ã€Œ${currentQuiz.song_title}ã€ã®${currentQuiz.explanation}éƒ¨åˆ†ã®æ­Œè©ã§ã—ãŸï¼`
      : "";


    resultEl.classList.remove("correct", "incorrect", "animate");

    resultEl.textContent = isCorrect
      ? `â­• æ­£è§£ï¼ğŸ˜„ï¼ˆæ­£è§£ï¼š${correct.join("ãƒ»")}ï¼‰`
      : `âŒ ä¸æ­£è§£ï¼ğŸ˜«ï¼ˆæ­£è§£ï¼š${correct.join("ãƒ»")}ï¼‰`;

    explanationEl.textContent = explanationText;

    resultEl.classList.add(isCorrect ? "correct" : "incorrect");
    void resultEl.offsetWidth;
    resultEl.classList.add("animate");

    // â˜… æ­£è§£ãƒ»ä¸æ­£è§£è¡¨ç¤ºå¾Œã«ç”»é¢ä¸‹ã¾ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
  setTimeout(() => {
    window.scrollTo({
      top: document.body.scrollHeight,
      behavior: "smooth"
    });
  }, 100);

    if (isCorrect) quizState.correctCount++;
    localStorage.setItem("quizState", JSON.stringify(quizState));

    submitBtn.disabled = true;
    document.getElementById("nextBtn").style.display = "inline-block";
  };

  // æ¬¡ã®å•é¡Œãƒœã‚¿ãƒ³
  document.getElementById("nextBtn").onclick = () => {
    currentIndex++;
    if (currentIndex < quizzes.length) {
      showQuiz(currentIndex);

      // â˜… ç”»é¢ã‚’ä¸€ç•ªä¸Šã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
      window.scrollTo({
        top: 0,
        behavior: "smooth"
      });
    } else {
    // çµ‚äº†æ™‚ã«result.htmlã¸é£›ã°ã™
    location.href = "result.html";
    }
  };
  </script>

</body>
</html>
