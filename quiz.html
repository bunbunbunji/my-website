<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <link rel="icon" href="icon.png" type="image/png">
  <link rel="apple-touch-icon" href="icon.png">
  <title>ã ã‚ŒãŒæ­Œã£ã¦ã‚‹ï¼Ÿ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="styles.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Mochiy+Pop+One&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>

<style>
  /* å…¨ä½“ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆèª¿æ•´ */
  .progress-container { 
    width: 100%; 
    height: 6px; 
    background: #eee; 
    border-radius: 4px; 
    margin-bottom: 10px; 
    overflow: hidden; 
  }
  .progress-bar { 
    height: 100%; 
    background: linear-gradient(90deg, #ffb6c1, #ff69b2); 
    width: 0%; 
    transition: width 0.4s; 
  }

  /* #1 ã‚¯ã‚¤ã‚ºã‚¿ã‚¤ãƒˆãƒ«ã®ã‚µã‚¤ã‚ºã‚’å°ã•ã */
  .quiz-title {
    font-size: 1.1rem !important;
    color: #888;
    margin-top: 5px;
    margin-bottom: 15px;
    text-shadow: none;
  }

  /* #2 ãƒ¡ã‚¤ãƒ³æ­Œè©ã®ã‚µã‚¤ã‚ºã‚’å¤§ãã */
  #lyrics { 
    font-size: 1.4rem; 
    font-weight: normal; 
    color: #333;
    margin: 20px 0; 
    line-height: 1.6;
    padding: 0 10px;
    letter-spacing: 0.03em;
    word-break: break-all;
  }

  /* ãƒ’ãƒ³ãƒˆæ­Œè©ã®è£…é£¾ */
  .hint-lyrics { 
    font-size: 0.75rem;
    font-weight: normal; 
    color: #aaa;
    background: #fdfdfd; 
    border: 1px dashed #eee;
    padding: 8px; 
    border-radius: 8px; 
    margin: 8px 0; 
    line-height: 1.4;
    letter-spacing: 0.05em;
  }
  .hint-label { font-weight: bold; color: #ffb6c1; font-size: 0.75rem; }

  /* ãƒ¡ãƒ³ãƒãƒ¼ãƒœã‚¿ãƒ³ã®ã‚°ãƒªãƒƒãƒ‰é…ç½® */
  .members { 
    display: grid; 
    grid-template-columns: 1fr 1fr; 
    gap: 10px; 
    width: 100%; 
    max-width: 320px; 
    margin: 20px auto; 
  }

  /* #3 å„ãƒ¡ãƒ³ãƒãƒ¼ãƒœã‚¿ãƒ³ã®æ–°ã—ã„StyleæŒ‡å®š */
  .member-btn {
    width: 100% !important;
    max-width: 150px;
    display: block;
    margin: 0 auto !important;
    font-size: 0.85rem;
    font-weight: normal !important;
    padding: 10px 0;
    background-color: #ffffff !important;
    color: #888 !important;
    border: 1px solid #e0e0e0 !important;
    outline: none !important;
    border-radius: 20px;
    box-shadow: 0 2px 0px #eee !important;
    cursor: pointer;
    transition: transform 0.1s, box-shadow 0.1s, background-color 0.1s;
    position: relative;
    top: 0 !important;
    /* ã‚¹ãƒãƒ›ã§ã‚¿ãƒƒãƒ—ã—ãŸæ™‚ã®é’ã„ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’æ¶ˆã™ */
    -webkit-tap-highlight-color: transparent;
  }

  /* --- ğŸ–±ï¸ PCç‰ˆï¼ˆãƒã‚¦ã‚¹æ“ä½œï¼‰ã®ã¿æµ®ãä¸ŠãŒã‚‹è¨­å®š --- */
  @media (hover: hover) {
    .member-btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 4px 0px #eee !important;
      background-color: #fffafc !important;
    }
    .member-btn.on:hover:not(:disabled) {
      box-shadow: 0 4px 0px #d81b60 !important;
    }
  }

  /* --- ğŸ“± ã‚¹ãƒãƒ›ç‰ˆï¼ˆã‚¿ãƒƒãƒæ“ä½œï¼‰ã§ã¯hoverã‚’ç„¡åŠ¹åŒ– --- */
  @media (hover: none) {
    .member-btn:hover {
      /* hoverã—ã¦ã‚‚é€šå¸¸æ™‚ã¨åŒã˜çŠ¶æ…‹ã‚’ç¶­æŒã™ã‚‹ */
      transform: none !important;
      background-color: #ffffff !important;
      box-shadow: 0 2px 0px #eee !important;
    }
    /* é¸æŠä¸­ãƒœã‚¿ãƒ³ã®hoverç¶­æŒã‚‚é˜²ã */
    .member-btn.on:hover {
      background-color: #ff69b2 !important;
      box-shadow: 0 2px 0px #d81b60 !important;
    }
  }

  /* ã‚¿ãƒƒãƒ—ãƒ»ã‚¯ãƒªãƒƒã‚¯æ™‚ã®æ²ˆã¿è¾¼ã¿ï¼ˆå…¨å…±é€šï¼šæŠ¼ã—ãŸç¬é–“ã ã‘åå¿œï¼‰ */
  .member-btn:active:not(:disabled) {
    transform: translateY(2px) !important;
    box-shadow: 0 0px 0px #eee !important;
    transition: 0s; /* æŠ¼ã—ãŸç¬é–“ã®åå¿œã‚’æœ€é€Ÿã« */
  }

  /* é¸æŠæ™‚ã®çŠ¶æ…‹ */
  .member-btn.on { 
    background-color: #ff69b2 !important; 
    color: #fff !important; 
    border-color: #ff69b2 !important; 
    box-shadow: 0 2px 0px #d81b60 !important;
  }

  /* å…¨å“¡ãƒœã‚¿ãƒ³ */
  .member-btn.all-btn { 
    background-color: #f8f8f8 !important; 
    border-style: dashed !important;
    color: #777 !important;
  }

  /* å›ç­”ãƒ»æ¬¡ã®å•é¡Œã¸ãƒœã‚¿ãƒ³ */
  .submit {
    margin-top: 20px;
    width: 70% !important;
  }

  /* æ­£è§£ãƒ»ä¸æ­£è§£è¡¨ç¤º */
  #result.animate { 
    animation: result-pop 0.5s ease-out; 
    padding: 12px; 
    border-radius: 12px; 
    font-weight: bold; 
    margin: 15px auto;
    width: 80%;
    max-width: 300px;
    font-size: 0.95rem;
    display: block;
    text-align: center;
    text-shadow: 1px 1px 0 #fff, -1px -1px 0 #fff, 1px -1px 0 #fff, -1px 1px 0 #fff;
  }
  @keyframes result-pop { 
    0% { opacity: 0; transform: scale(0.8); } 
    100% { opacity: 1; transform: scale(1); } 
  }
  .correct { 
    background: #e8f5e9 !important; 
    color: #2e7d32 !important; 
    border: 2px solid #4caf50;
  }
  .incorrect { 
    background: #ffebee !important; 
    color: #d32f2f !important; 
    border: 2px solid #f44336; 
  }

  /* è§£èª¬ãƒ†ã‚­ã‚¹ãƒˆ */
  #explanation {
    font-size: 0.9rem;
    color: #666;
    line-height: 1.6;
    margin: 10px 0;
    padding: 0 10px;
  }

  /* --- ã‚¹ãƒãƒ›ç‰ˆã®ä½™ç™½èª¿æ•´ --- */
  @media (max-width: 480px) {
    body {
      align-items: flex-start !important;
      height: auto !important; 
      padding-top: 10px !important; 
    }

    .box {
      margin-top: 5px !important;
      padding: 15px 10px !important;
      width: 95% !important;
    }

    .title {
      margin-bottom: 10px !important;
      font-size: 1.2rem !important;
    }
  }
  .warning { 
  background: #fff3e0 !important; /* è­¦å‘Šã‚‰ã—ã„è–„ã‚ªãƒ¬ãƒ³ã‚¸ */
  color: #ef6c00 !important;    /* æ¿ƒã„ã‚ªãƒ¬ãƒ³ã‚¸ */
  border: 2px solid #ffb74d !important;
  text-shadow: 1px 1px 0 #fff, -1px -1px 0 #fff, 1px -1px 0 #fff, -1px 1px 0 #fff;
  }
</style>

<body class="scroll-page">

  <div class="box">
    <p id="quiz-counter" style="text-align: center; font-size: 14px; color: #888; margin-bottom: 5px;"></p>
      <div class="progress-container">
        <div id="progress-bar" class="progress-bar"></div>
      </div>
    <h2 class="title quiz-title">ã ã‚ŒãŒæ­Œã£ã¦ã‚‹ï¼Ÿ</h2>
    <div id="prev-lyrics" class="hint-lyrics" style="display:none;"></div>
    <p id="lyrics">èª­ã¿è¾¼ã¿ä¸­â€¦</p>
    <div id="next-lyrics" class="hint-lyrics" style="display:none;"></div>
    <div class="members" id="members"></div>
    <button class="submit" id="submitBtn">å›ç­”ã™ã‚‹</button>
    <p id="result"></p>
    <div id="explanation"></div>
    <button class="submit" id="nextBtn" style="display:none;">æ¬¡ã®å•é¡Œã¸</button>
  </div>

  <script>
    // 1. ã¾ãšSupabaseã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’å³åº§ã«ä½œæˆã™ã‚‹
    const SUPABASE_URL = "https://atinpqtedmrfrtdlkpkd.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF0aW5wcXRlZG1yZnJ0ZGxrcGtkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkwOTU0NjcsImV4cCI6MjA4NDY3MTQ2N30.Oor6oUuuIxa0pSxIRuwEw7ZzGYM4hOGfywHqv2FaBHg";
    
    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY, {
      auth: {
        persistSession: false,
        storageKey: 'sb-temp',
        storage: {
          getItem: () => null,
          setItem: () => {},
          removeItem: () => {}
        }
      }
    });

    // 2. ãã®ä»–ã®å¤‰æ•°è¨­å®š
    const quizState = JSON.parse(localStorage.getItem("quizState"));
    if (!quizState) location.href = "index.html";

    let quizzes = [];
    let currentIndex = 0;
    let currentQuiz = null;
    let members = [];
    let selectedMembers = new Set();

    // 3. ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿é–¢æ•°
    async function loadQuizzesAndMembers() {
      // ğŸš€ ä¿®æ­£ï¼šé¸æŠã•ã‚ŒãŸé›£æ˜“åº¦ã®ã‚«ãƒ©ãƒ ãŒ 0 ã‚ˆã‚Šå¤§ãã„ï¼ˆå‡ºé¡Œå¯¾è±¡ï¼‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
      const { data: quizData, error: quizError } = await supabaseClient
        .from("quizzes")
        .select("*")
        .eq("group_name", quizState.group)
        .gt(quizState.difficulty, 0); 

      if (quizError || !quizData || quizData.length === 0) {
        document.getElementById("lyrics").textContent = "å•é¡Œã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ";
        return;
      }

      // ğŸš€ ä¿®æ­£ï¼šé‡ã¿ä»˜ãæŠ½é¸ãƒ­ã‚¸ãƒƒã‚¯ (é›£æ˜“åº¦ã‚«ãƒ©ãƒ ã®å€¤ã‚’é‡ã¿ã¨ã—ã¦10å•é¸å‡º)
      const selectedQuizzes = [];
      const tempPool = [...quizData];
      const maxQuestions = 10;
      const diffKey = quizState.difficulty; // "easy", "normal", "hard", "expert"

      for (let i = 0; i < maxQuestions && tempPool.length > 0; i++) {
        // ç¾åœ¨ã®ãƒ—ãƒ¼ãƒ«å†…ã®é‡ã¿ã®åˆè¨ˆã‚’è¨ˆç®—
        const totalWeight = tempPool.reduce((sum, q) => sum + (q[diffKey] || 0), 0);
        let random = Math.random() * totalWeight;

        for (let j = 0; j < tempPool.length; j++) {
          random -= tempPool[j][diffKey];
          if (random <= 0) {
            selectedQuizzes.push(tempPool[j]);
            tempPool.splice(j, 1); // é¸ã°ã‚ŒãŸå•é¡Œã‚’é‡è¤‡ã—ãªã„ã‚ˆã†å‰Šé™¤
            break;
          }
        }
      }

      quizzes = selectedQuizzes;
      console.log("ã€ãƒ‡ãƒãƒƒã‚°ã€‘é‡ã¿ä»˜ãæŠ½é¸çµæœ:", quizzes.map(q => ({id: q.id, weight: q[diffKey]})));

      if (quizzes.length === 0) {
        document.getElementById("lyrics").textContent = "æ¡ä»¶ã«åˆã†å•é¡ŒãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ";
        return;
      }

      // ãƒ¡ãƒ³ãƒãƒ¼å–å¾—
      const { data: memberData, error: memberError } = await supabaseClient
        .from("members")
        .select("*")
        .eq("group_name", quizState.group)
        .order("sort_order");

      if (!memberError && memberData) {
        members = memberData;
        showQuiz(0);
      }
    }

    function showQuiz(index) {
      currentIndex = index;
      currentQuiz = quizzes[index];
      
      document.getElementById("quiz-counter").textContent = `${index + 1} / ${quizzes.length} å•ç›®`;
      const progressPercent = ((index + 1) / quizzes.length) * 100;
      document.getElementById("progress-bar").style.width = progressPercent + "%";

      document.getElementById("lyrics").textContent = currentQuiz.lyrics_main;

      const prevEl = document.getElementById("prev-lyrics");
      const nextEl = document.getElementById("next-lyrics");

      // ğŸš€ ä¿®æ­£ï¼šã€Œã’ãã‚€ãš (expert)ã€ã¨ã€Œã‚€ãšã‹ã—ã„ (hard)ã€ã¯ãƒ’ãƒ³ãƒˆéè¡¨ç¤º
      if (quizState.difficulty === "easy") {
        const prevText = [currentQuiz.lyrics_prev1, currentQuiz.lyrics_prev2].filter(t => t).join("<br>");
        const nextText = [currentQuiz.lyrics_next1, currentQuiz.lyrics_next2].filter(t => t).join("<br>");
        updateHint(prevEl, "-ç›´å‰ã®æ­Œè©-", prevText);
        updateHint(nextEl, "-ç›´å¾Œã®æ­Œè©-", nextText);
      } else if (quizState.difficulty === "normal") {
        updateHint(prevEl, "-ç›´å‰ã®æ­Œè©-", currentQuiz.lyrics_prev2);
        updateHint(nextEl, "-ç›´å¾Œã®æ­Œè©-", currentQuiz.lyrics_next1);
      } else {
        // hard, expert ã®å ´åˆã¯ãƒ’ãƒ³ãƒˆã‚’éš ã™
        prevEl.style.display = "none";
        nextEl.style.display = "none";
      }

      selectedMembers.clear();
      renderMembers();
      const resultEl = document.getElementById("result");
      resultEl.textContent = "";
      resultEl.className = ""; 
      
      const explanationEl = document.getElementById("explanation");
      explanationEl.textContent = "";

      const submitBtn = document.getElementById("submitBtn");
      submitBtn.style.display = "block"; 
      submitBtn.disabled = false;
      
      document.getElementById("nextBtn").style.display = "none";
    }

    function updateHint(el, label, text) {
      if (text && text.trim() !== "") {
        el.innerHTML = `<span class="hint-label">${label}</span><br>${text}`;
        el.style.display = "block";
      } else {
        el.style.display = "none";
      }
    }

    function renderMembers() {
      const container = document.getElementById("members");
      container.innerHTML = "";
      
      members.forEach(m => {
        const btn = document.createElement("button");
        btn.textContent = m.name;
        btn.className = "member-btn";
        btn.onclick = () => {
          if (selectedMembers.has(m.name)) {
            selectedMembers.delete(m.name);
            btn.classList.remove("on");
          } else {
            selectedMembers.add(m.name);
            btn.classList.add("on");
          }
        };
        container.appendChild(btn);
      });

      const allBtn = document.createElement("button");
      allBtn.textContent = "å…¨å“¡";
      allBtn.className = "member-btn all-btn";

      allBtn.onclick = () => {
        const memberButtons = document.querySelectorAll(".member-btn:not(.all-btn)");
        const allOn = [...memberButtons].every(b => b.classList.contains("on"));

        memberButtons.forEach(b => {
          if (allOn) { 
            b.classList.remove("on"); 
            selectedMembers.delete(b.textContent); 
          } else { 
            b.classList.add("on"); 
            selectedMembers.add(b.textContent); 
          }
        });
        allBtn.classList.toggle("on", !allOn);
      };
      container.appendChild(allBtn);
    }

    document.getElementById("submitBtn").onclick = () => {
      if (selectedMembers.size === 0) {
        const res = document.getElementById("result");
        res.textContent = "âš ï¸ ãƒ¡ãƒ³ãƒãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„ï¼";
        res.className = "animate warning";
        res.style.display = "block";
        return; 
      }

      const correct = currentQuiz.correct_members.split(",").map(s => s.trim()).sort();
      const answer = Array.from(selectedMembers).sort();
      const isCorrect = correct.length === answer.length && correct.every((v, i) => v === answer[i]);

      const res = document.getElementById("result");
      res.textContent = isCorrect ? `â­• æ­£è§£ï¼ğŸ˜„ï¼ˆæ­£è§£ï¼š${correct.join("ãƒ»")}ï¼‰` : `âŒ ä¸æ­£è§£ï¼ğŸ˜«ï¼ˆæ­£è§£ï¼š${correct.join("ãƒ»")}ï¼‰`;
      res.className = isCorrect ? "correct animate" : "incorrect animate";

      document.getElementById("explanation").textContent = (currentQuiz.song_title && currentQuiz.explanation) ? `ã“ã®æ­Œè©ã¯ã€Œ${currentQuiz.song_title}ã€ã®${currentQuiz.explanation}éƒ¨åˆ†ã§ã—ãŸï¼` : "";
      
      if (isCorrect) quizState.correctCount++;
      localStorage.setItem("quizState", JSON.stringify(quizState));

      document.getElementById("submitBtn").style.display = "none";
      document.getElementById("nextBtn").style.display = "block"; 
      
      setTimeout(() => window.scrollTo({ top: document.body.scrollHeight, behavior: "smooth" }), 100);
    };

    document.getElementById("nextBtn").onclick = () => {
      if (currentIndex + 1 < quizzes.length) {
        showQuiz(currentIndex + 1);
        window.scrollTo({ top: 0, behavior: "smooth" });
      } else {
        location.href = "result.html";
      }
    };

    loadQuizzesAndMembers();
  </script>
</body>
</html>
