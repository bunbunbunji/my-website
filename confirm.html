<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>å‡ºé¡Œå†…å®¹ã®ç¢ºèª</title>
  <link rel="icon" href="icon.png" type="image/png">
  <link rel="apple-touch-icon" href="icon.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Mochiy+Pop+One&display=swap" rel="stylesheet">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />


  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- å…±é€šã‚¹ã‚¿ã‚¤ãƒ« -->
  <link rel="stylesheet" href="styles.css">

<style>
  /* å…¨ä½“ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆèª¿æ•´ */
  .confirm-container {
    text-align: center;
    padding: 10px 20px;
  }

  /* --- #1: info-card ã‚’ã‚¹ãƒªãƒ ã«èª¿æ•´ --- */
  .info-card {
    background: #ffffff !important;
    background-image: radial-gradient(#fff0f5 15%, transparent 15%) !important;
    background-size: 15px 15px !important;
    border: 3px solid #ffb7d5 !important;
    border-radius: 30px !important;
    padding: 15px 20px !important; /* ä¸Šä¸‹ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’ 30px â†’ 15px ã«ç¸®å° */
    margin: 15px auto !important;   /* å¤–å´ã®ä½™ç™½ã‚‚å°‘ã—è©°ã‚ã¾ã—ãŸ */
    box-shadow: 0 10px 25px rgba(255, 105, 180, 0.15) !important;
    max-width: 300px;
    position: relative;
  }

  .confirm-item {
    margin: 8px 0; /* é …ç›®é–“ã®éš™é–“ã‚’å°‘ã—è©°ã‚ã¾ã—ãŸ */
  }

  .confirm-label {
    font-size: 0.75rem;
    color: #ff8ab4;
    display: block;
    margin-bottom: 2px;
    font-weight: bold;
  }

  /* é¸æŠå€¤ã®æ–‡å­—ã‚µã‚¤ã‚ºã‚‚ã€ã‚«ãƒ¼ãƒ‰ã«åˆã‚ã›ã¦å¾®èª¿æ•´ */
  .confirm-value {
    display: block;
    font-size: 1.5rem !important; /* 1.8rem â†’ 1.5rem ã«èª¿æ•´ */
    font-weight: 900 !important;
    margin-bottom: 5px; /* ä¸‹ã®ä½™ç™½ã‚’è©°ã‚ã¾ã—ãŸ */
    
    background: linear-gradient(90deg, #ff1493, #ff8a65, #ff1493) !important;
    background-size: 200% auto !important;
    background-clip: text !important;
    -webkit-background-clip: text !important;
    color: transparent !important;
    -webkit-text-fill-color: transparent !important;
    animation: textShine 4s linear infinite;
  }

  @keyframes textShine {
    to { background-position: 200% center; }
  }

  /* --- ğŸš€ ã‚¯ã‚¤ã‚ºã‚’å§‹ã‚ã‚‹ãƒœã‚¿ãƒ³ --- */
  .start-btn {
    all: unset;
    display: inline-block !important;
    box-sizing: border-box !important;
    cursor: pointer !important;
    width: 90% !important;
    max-width: 280px !important;
    height: 60px !important; /* é«˜ã•ã‚’å°‘ã—æŠ‘ãˆã¦ã‚¹ãƒƒã‚­ãƒªã•ã›ã¾ã—ãŸ */
    line-height: 60px !important;
    background: linear-gradient(45deg, #ff007f, #ff69b2, #ff8a65) !important;
    background-size: 200% 200% !important;
    color: #ffffff !important;
    font-size: 1.2rem !important;
    font-weight: bold !important;
    font-family: "Mochiy Pop One", sans-serif !important;
    border-radius: 100px !important;
    border: 4px solid #fff !important;
    box-shadow: 0 8px 0px #c2185b, 0 12px 20px rgba(255, 20, 147, 0.3) !important;
    position: relative !important;
    overflow: hidden !important;
    transition: all 0.3s ease !important;
    animation: gradientShift 3s ease infinite, pulse 2s infinite;
  }

  /* --- #2: ãƒœã‚¿ãƒ³ã®é–“éš”ã‚’é›¢ã™ --- */
  .back-btn {
    margin-top: 25px !important; /* ã‚¯ã‚¤ã‚ºã‚’å§‹ã‚ã‚‹ãƒœã‚¿ãƒ³ã¨ã®è·é›¢ã‚’ç¢ºä¿ */
  }

  @keyframes gradientShift {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
  }

  @keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.03); }
    100% { transform: scale(1); }
  }

  .start-btn::after {
    content: '';
    position: absolute;
    top: -100%;
    left: -150%;
    width: 80%;
    height: 300%;
    background: rgba(255, 255, 255, 0.5);
    transform: rotate(30deg);
    animation: megaShine 3.5s infinite;
  }

  @keyframes megaShine {
    0% { left: -150%; }
    25% { left: 150%; }
    100% { left: 150%; }
  }

  .start-btn:hover {
    transform: translateY(-3px) scale(1.05) !important;
    filter: brightness(1.1);
    box-shadow: 0 10px 0px #c2185b, 0 15px 25px rgba(255, 20, 147, 0.4) !important;
  }

  .start-btn:active {
    transform: translateY(2px) !important;
    box-shadow: 0 4px 0px #c2185b !important;
  }
</style>

</head>
<body class="locked">

  <div class="box">
    <h2 class="title">å‡ºé¡Œå†…å®¹ã®ç¢ºèª</h2>

    <div class="info-card">
      <div class="confirm-item">
        <span class="confirm-label">ã‚°ãƒ«ãƒ¼ãƒ—</span>
        <span id="group" class="confirm-value">å–å¾—ä¸­â€¦</span>
      </div>
      
      <div class="confirm-item">
        <span class="confirm-label">é›£æ˜“åº¦</span>
        <span id="difficulty" class="confirm-value">å–å¾—ä¸­â€¦</span>
      </div>
      
      <p id="status" style="font-weight: bold; color: #ff69b2; margin-top: 10px;">å•é¡Œã‚’æº–å‚™ã—ã¦ã„ã¾ã™â€¦</p>
    </div>

    <div id="description" style="display:none; margin-bottom:20px; font-size:14px; line-height:1.6; color: #888;">
    </div>

    <button id="startBtn" class="start-btn" disabled>ã‚¯ã‚¤ã‚ºã‚’å§‹ã‚ã‚‹</button>
    
    <button class="back-btn" onclick="location.href='difficulty.html'">é›£æ˜“åº¦é¸æŠã«æˆ»ã‚‹</button>
  </div>

  <script>
    // ===== Supabase è¨­å®š =====
    const supabaseUrl = "https://atinpqtedmrfrtdlkpkd.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF0aW5wcXRlZG1yZnJ0ZGxrcGtkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkwOTU0NjcsImV4cCI6MjA4NDY3MTQ2N30.Oor6oUuuIxa0pSxIRuwEw7ZzGYM4hOGfywHqv2FaBHg";
    const supabaseClient = window.supabase.createClient(supabaseUrl, supabaseKey);

    // ===== çŠ¶æ…‹å–å¾— =====
    const state = JSON.parse(localStorage.getItem("quizState"));

    if (!state || !state.group || !state.difficulty) {
      location.href = "group.html";
    }

    // ã‚¯ãƒ©ã‚¹åã«å½±éŸ¿ã‚’ä¸ãˆãšä¸­èº«ã ã‘æ›¸ãæ›ãˆã‚‹
    document.getElementById("group").textContent = state.group;

    const difficultyLabel = {
      easy: "ã‚„ã•ã—ã„",
      normal: "ãµã¤ã†",
      hard: "ã‚€ãšã‹ã—ã„"
    };
    document.getElementById("difficulty").textContent = difficultyLabel[state.difficulty];

    // ===== ã‚¯ã‚¤ã‚ºå–å¾— =====
    async function prepareQuiz() {
      const { data, error } = await supabaseClient
        .from("quizzes")
        .select(`id, ${state.difficulty}`) // é›£æ˜“åº¦åˆ—ï¼ˆeasyç­‰ï¼‰ã¨ãã®å€¤ã‚’å–å¾—
        .eq("group_name", state.group)
        .gt(state.difficulty, 0); // å€¤ãŒ 0 ã‚ˆã‚Šå¤§ãã„ï¼ˆå‡ºé¡Œå¯¾è±¡ï¼‰ã‚‚ã®ã‚’å–å¾—

      if (error || !data || data.length === 0) {
        document.getElementById("status").textContent = "å•é¡ŒãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ";
        return;
      }

      // --- ğŸš€ é‡ã¿ä»˜ãæŠ½é¸ãƒ­ã‚¸ãƒƒã‚¯ ---
      const selectedIds = [];
      const tempPool = [...data]; // å–å¾—ã—ãŸãƒ‡ãƒ¼ã‚¿ã®ã‚³ãƒ”ãƒ¼
      const maxQuestions = 10;

      for (let i = 0; i < maxQuestions && tempPool.length > 0; i++) {
        // å…¨ä½“ã®é‡ã¿ã®åˆè¨ˆã‚’è¨ˆç®—
        const totalWeight = tempPool.reduce((sum, q) => sum + q[state.difficulty], 0);
        let random = Math.random() * totalWeight;
        
        // é‡ã¿ã«åŸºã¥ã„ã¦å½“é¸ã‚’æ±ºå®š
        for (let j = 0; j < tempPool.length; j++) {
          random -= tempPool[j][state.difficulty];
          if (random <= 0) {
            selectedIds.push(tempPool[j].id);
            tempPool.splice(j, 1); // åŒã˜å•é¡ŒãŒé¸ã°ã‚Œãªã„ã‚ˆã†ã«ãƒ—ãƒ¼ãƒ«ã‹ã‚‰å‰Šé™¤
            break;
          }
        }
      }

      state.quizIds = selectedIds;
      localStorage.setItem("quizState", JSON.stringify(state));
      // --- ã“ã“ã¾ã§ ---

      document.getElementById("status").textContent = `${state.quizIds.length}å•ã®ã‚¯ã‚¤ã‚ºã‚’ç”¨æ„ã—ã¾ã—ãŸï¼`;
      document.getElementById("description").style.display = "block";
      const btn = document.getElementById("startBtn");
      btn.disabled = false;
      btn.onclick = () => { location.href = "quiz.html"; };
    }

    prepareQuiz();
  </script>

</body>
</html>
